name: Rota Inventory Infrastructure

trigger: none
pr: none

pool:
   name: 'Azure Pipelines'

jobs:
 - job: create_arm_dev
   steps:
     - task: JTranTransform@1.0.2
       displayName: 'Create JAG Manifest'
       inputs:
         InputSourcePath:            $(Build.SourcesDirectory)/Tests/blank.json
         TransformPath:              $(Build.SourcesDirectory)/Tests/rota-inventory.jtran
         IncludePath:                $(Build.SourcesDirectory)/Tests/microservice.jtran
         OutputDestinationPath:      $(Build.ArtifactStagingDirectory)/rota-inventory.jag
         MultipleOutput:             false
         TransformParameters:        '-environment dev'

     - task: JTranTransform@1.0.2
       displayName: 'Create Flat File'
       inputs:
         InputSourcePath:            $(Build.ArtifactStagingDirectory)/rota-inventory.jag
         TransformPath:              $(Build.SourcesDirectory)/Tests/jag2flat.jtran
         IncludePath:                $(Build.SourcesDirectory)/Templates/Resources/*.*
         OutputDestinationPath:      $(Build.ArtifactStagingDirectory)/rota-inventory.flat
         MultipleOutput:             false
         TransformParameters:        '-environment dev'

     - task: JTranTransform@1.0.2
       displayName: 'Create ARM Template'
       inputs:
         InputSourcePath:            $(Build.ArtifactStagingDirectory)/rota-inventory.flat
         TransformPath:              $(Build.SourcesDirectory)/Tests/jag2arm.jtran
         IncludePath:                $(Build.SourcesDirectory)/Templates/Resources/*.*
         OutputDestinationPath:      $(Build.ArtifactStagingDirectory)/rota-inventory.arm
         MultipleOutput:             false
         TransformParameters:        '-environment dev'

     - task: AzureResourceManagerTemplateDeployment@3
       displayName: Deploy ARM Template'
       inputs:
         deploymentScope:                   'Resource Group'
         azureResourceManagerConnection:    JTranOrg_AzureRM
         subscriptionId:                    367aecbd-8fb0-4d19-9ede-100949e08abc
         action:                            'Create Or Update Resource Group'
         resourceGroupName:                 rg-rota-inventory-dev
         templateLocation:                  'Linked artifact'
         csmFileLink:                       $(Build.ArtifactStagingDirectory)/rota-inventory.arm
         deploymentMode:                    Incremental
